<!DOCYTIPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Active Record</title>
		<style type="text/css">
			body {
				width: 900px;
				padding: 50px;
				margin: 0 auto;
				font-family: monospace;
			}

			table {
				width: 100%
			}

			table td ul li{
				list-style: none;
				float: left;
				padding-left: 5px;
			}

			table th:nt-child {
				width: 100px;
			}

			#loading {
				display: none;
				z-index: 9999;
				position: fixed;
				text-align: center;
				font-weight: bold;
				background: rgba(200,200,125,0.5);
				padding: 10px;
				margin-left: 400px;
			}

			.alert ul {
				font-weight: bold;
				display: none;
				padding: 10px 10px 10px 40px;
			}

			.alert #error {
				background: rgba(200,0,0,0.5);
			}

			.alert #info {
				background: rgba(0,100,200,0.5);
			}

			.alert #warning {
				background: rgba(200,200,0,0.5);
			}

			.terminal {
				position: fixed;
				z-index: 9999;
				width: 99%;
				left: 5px;
				bottom: -244px;
				border: 1px solid #000;
				background: rgba(0,0,0,0.5);
				transition: bottom 0.1s linear 0.1s;
				overflow: hidden;
			}
			.terminal .terminal-header {
				text-align: center;
				font-weight: bold;
				padding-top: 5px;
				color: #CCC;
				border: 2px solid #000;
			}
			.terminal .terminal-body {
				width: 100%;
				height: 180px;
				background: rgba(0,0,0,0.5);
				color: green;
				padding: 5px 0 0 5px;
				overflow: hidden;
				overflow-y: visible;
			}

			.terminal-body ul {

				list-style: none;
				padding-left: 5px;
			}

			.terminal .terminal-footer input {
				width: 100%;
				background-color: rgba(0,0,0,0.5);
				border: 1px solid rgba(0,0,0,0.5);
				color: green;
			}

			.show-terminal {
				position: fixed;
				z-index: 10000;
				width: 100px;
				left: 50%;
				bottom: 0px;
				padding: 5px;
				margin-left: -5%;
				border: 1px solid #000;
				background: rgba(0,0,0,0.5);
				text-align: center;
				transition: bottom 0.1s linear 0.1s;
			}
		</style>
	</head>

	<body>
		<div class="show-terminal" id="off">$_ ~:</div>
		<div class="terminal">
			<div class="terminal-header">/home/3kg4kR/active_record/tests</div>
			<div class="terminal-body">
				<ul class="code"></ul>
			</div>
			<div class="terminal-footer">
				<form action="/" method="POST" name="terminal-form">
					<input type="text" />
					<input type="submit" value="Search" style="display:none">
				</form>
			</div>
		</div>
		<div id="loading">Loading...</div>
		<h1>Active Record Test</h1>
		<section>
			<form action="/search" method="GET" name="search">
				<input type="search" placeholder="Search" name="q">
				<input type="submit" value="Search">
			</form>
		</section>
		<hr />
		<section>
			<form action="/new" method="POST" name="create">
				<label>Name:</label>
				<input type="text" placeholder="Name" name="name" />
				<label>Password</label>
				<input type="password" placeholder="Password" name="password" />
				<input type="submit" value="Create" class="ui button">
			</form>
			<div class="alert">
				<ul id="info"></ul>
			</div>
		</section>
		<hr />
		<section>
			<table class="response">
				<thead>
					<tr>
						<th style="width: 50px">#</th>
						<th>Name</th>
						<th>Password</th>
						<th style="width: 150px">Actions</th>
					</tr>
				</thead>
				<tbody class="response-body"></tbody>
			</table>
		</section>

		<!-- JUST FOR FUN -->
		<script type="text/javascript">
		function User () {};
		</script>

		<script type="text/javascript">
			var terminal = document.querySelector('.terminal');
			var terminalBody = terminal.querySelector('.terminal-body');
			var terminalBodyUl = terminal.querySelector('.terminal-body .code');
			var terminalForm = terminal.querySelector('form[name="terminal-form"]');
			var openTerminal = document.querySelector('.show-terminal');

			openTerminal.addEventListener('click', function (evt){
				if (this.id=="off"){
					this.style.bottom = "244px";
					this.id="on";
					terminal.style.bottom = "0px";
				} else {
					this.style.bottom = "0px";
					this.id="off";
					terminal.style.bottom = "-244px";
				}

				var input = terminalForm.querySelector('input[type="text"]');
				input.innerText = "";
				input.focus();
			})

			terminalForm.addEventListener('submit', function (evt){
				evt.preventDefault();
				var input = evt.target[0]
				var line = document.createElement('li');

				if (input.value !== ""){
					var exec = null;
					var resultLine = document.createElement('li');

					line.innerHTML = "$> ~: "+ input.value;
					terminalBodyUl.appendChild(line);

					try {
						exec = eval(input.value);
					} catch (Exception){
						exec = Exception;
						resultLine.style.color = 'red';
					}

					resultLine.innerHTML = exec;
					terminalBodyUl.appendChild(resultLine);

					terminalBody.scrollTop = 1000;
				}

				input.value = "";
				input.focus();
			})

			var clear = function clear (){
				return terminalBodyUl.innerHTML = "";
			}
		</script>

		<script type="text/javascript">

			var loading = document.querySelector('#loading');
			var searchForm = document.querySelector('form[name="search"]');
			var Alert = document.querySelector('.alert ul');
			var response = document.querySelector('.response-body');

			User.search = function search (value){
				var xhr = new XMLHttpRequest();
				loading.style.display = "block";

				xhr.open("GET", "/search?q="+value , false);
				xhr.send();

				if (xhr.status == 200){
					response.innerHTML = "";
					loading.style.display = "none";
					json = JSON.parse(xhr.responseText);

					Alert.innerHTML = (json.length ? json.length : 0) + " User(s) found.";
					Alert.id = "warning";
					Alert.style.display = "block";

					if (json.message){
						response.innerHTML = "<tr><td colspan='2'>"+ json.message +"</td></tr>";
					} else {

						for (i in json){
							tr = document.createElement('tr');
							tds = "<td>"+ json[i].id +"</td><td>"+ json[i].name +"</td><td>"+ json[i].password +"</td><td><ul><li><a href='/delete' data-id='"+ json[i].id +"' class='delete'>Excluir</a></li><li><a href='#!update' data-id='"+ json[i].id +"' class='update'>Editar</a></li></td>";
							tr.innerHTML = tds;
							tr.id = "user_"+ json[i].id;
							response.appendChild(tr)
						}

						deletes = document.querySelectorAll('.delete');

						[].forEach.call(deletes, function (del){
							del.addEventListener('click', function (evt){
								evt.preventDefault();
								User.destroy.bind(this)(this.dataset.id);
							})
						})

						updates = document.querySelectorAll('.update');

						[].forEach.call(updates, function (del){
							del.addEventListener('submit', function (evt){
								evt.preventDefault();

								var xhr = new XMLHttpRequest();
								xhr.open("POST", '/update', false);
								// xhr.send(JSON.stringify({id :this.dataset.id}));

								var json = JSON.parse(xhr.responseText);

								if (xhr.status != 420){
									loading.style.display = "none";
								}
								Alert.innerHTML = "<li>"+ json.message + "</li>";
								Alert.id = "info";
								Alert.style.display = "block";
							})
						})
					}
				}
				return JSON.stringify(xhr.resultText);
			}

			searchForm.addEventListener('submit', function (evt){
				evt.preventDefault();
				User.search(evt.target[0].value);
			})
		</script>

		<script type="text/javascript">
			var create = document.querySelector('form[name="create"]');

			create.addEventListener('submit', function (evt){
				evt.preventDefault();
				var name = evt.target[0];
				var password = evt.target[1];

				if (User.create(name.value, password.value)){
					name.innerHTML = "";
					password.innerHTML = "";
				};
			})

			User.create = function create(name, password){
				var xhr = new XMLHttpRequest();

				var user = {
					name: name,
					password: password
				}

				xhr.open("POST", "/new", false);
				xhr.send(JSON.stringify(user));
				loading.style.display = "block";

				json = JSON.parse(xhr.response);

				if (xhr.status == 420){
					loading.style.display = "none";
					Alert.innerHTML = "";
					for ( i in json){
						li = document.createElement('li')
						li.innerHTML = json[i];
						Alert.appendChild(li);
					}
					Alert.id = "error"
					Alert.style.display = "block";
					return false;
				} else {
					Alert.id = "info";
					Alert.style.display = "block";
					Alert.innerHTML = json.message;
					loading.style.display = "none";

					tr = document.createElement('tr');
					td = "<td>"+ json.data.insertId +"</td><td>"+ json.data.object.name +"</td><td>"+ json.data.object.password +"</td><td><ul><li><a href='#!delete' onclick='User.destroy("+ json.data.insertId +")'>Excluir</a></li><li><a href='#!update' data-id='"+ json.data.object.id +"' class='update'>Editar</a></li></td>";
					tr.innerHTML = td;
					tr.id = "user_"+ json.data.id;
					response.appendChild(tr);
					return true;
				}
			}

			User.destroy = function destroy (id){
				var xhr = new XMLHttpRequest();
				xhr.open("POST", '/delete', false);
				xhr.send(JSON.stringify({id :id}));

				var json = JSON.parse(xhr.responseText);

				if (xhr.status != 420){
					if (this.parentElement)
						this.parentElement.parentElement.parentElement.parentElement.remove();
					else {
						var del = document.querySelector("#user_"+ id)
						if (del) del.remove();
					}
					loading.style.display = "none";
				}
				Alert.innerHTML = "<li>"+ json.message + "</li>";
				Alert.id = "info";
				Alert.style.display = "block";
			}
		</script>
	</body>
</html>
