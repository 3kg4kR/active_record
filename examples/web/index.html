<!DOCYTIPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" type="text/css" href="dist/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="dist/jquery.terminal.css">
		<script type="text/javascript" src="dist/jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="dist/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="dist/jquery.terminal-0.8.8.min.js"></script>
		<title>Active Record</title>
		<!--[if lt IE 9]>
	      	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	      	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	  <![endif]-->
		<style type="text/css">
			body {
				width: 900px;
				padding: 50px;
				margin: 0 auto;
				font-family: monospace;
			}

			table ul li {
				list-style: none;
				float: left;
				padding-left: 5px;
			}

			#loading {
				z-index: 9999;
				position: fixed;
				left: 48%;
			}

			@keyframes blink {
			  0% { opacity: 1; }
			  25% { opacity: 0; }
			  50% { opacity: 0; }
			  100% { opacity: 1; }
			}
			@-webkit-keyframes blink {
			  0% { opacity: 1; }
			  25% { opacity: 0; }
			  50% { opacity: 0; }
			  100% { opacity: 1; }
			}
			@-ms-keyframes blink {
			  0% { opacity: 1; }
			  25% { opacity: 0; }
			  50% { opacity: 0; }
			  100% { opacity: 1; }
			}
			@-moz-keyframes blink {
			  0% { opacity: 1; }
			  25% { opacity: 0; }
			  50% { opacity: 0; }
			  100% { opacity: 1; }
			}
			.prompt, .command {
			  color: #0c0;
			  text-shadow: 0 0 3px rgba(0,100,0,50);
			}
			.cursor {
			  background: #0c0;
			  animation: blink 1s linear infinite;
			  -webkit-animation: blink 1s infinite linear;
			  -ms-animation: blink 1s infinite linear;
			  -moz-animation: blink 1s infinite linear;
			  -webkit-box-shadow: 0 0 5px rgba(0,100,0,50);
			  -moz-box-shadow: 0 0 5px rgba(0,100,0,50);
			  -ms-box-shadow: 0 0 5px rgba(0,100,0,50);
			  -o-box-shadow: 0 0 5px rgba(0,100,0,50);
			  box-shadow: 0 0 5px rgba(0,100,0,50);
			}
		</style>
	</head>

	<body>
		<div class="modal fade">
			<div class="modal-header">
				Associations
			</div>
			<div class="modal-body"></div>
		</div>

		<div id="loading" class="label label-info">Loading...</div>

		<div class="page-header">
			<h1>
				<a href="http://www.github.com/3kg4kR/active_record" target="_blank">
					<img src="logo.png">
				</a>
				<small>test</small>
			</h1>
			<h6>By 3kg4kR (<a href="mailto:igor_sillva@hotmail.com">igor_sillva@hotmail.com</a>)</h6>
		</div>
		<button class="btn btn-primary" type="button">Model User <span class="badge">0</span></button>
		<div>&nbsp;</div>
		<section>
			<form class="form-inline" action="/search" method="GET" name="search">
				<input type="search" placeholder="Search" name="q">
				<button class="btn" type="submit">
					<i class="glyphicon glyphicon-search"></i>
				</button>
			</form>
		</section>
		<hr />
		<section>
			<form action="/new" method="POST" name="create">
				<label>Name:</label>
				<input type="text" placeholder="Name" name="name" />
				<label>Password:</label>
				<input type="password" placeholder="Password" name="password" />
				<button type="submit" class="btn btn-success">
					Create
				</button>
			</form>
		</section>
		<div class="alert"></div>
		<hr />
		<section>
			<table class="table table-condensed response">
				<thead>
					<tr>
						<th style="width: 50px">#</th>
						<th>Name</th>
						<th>Password</th>
						<th>Phones</th>
						<th style="width: 150px">Actions</th>
					</tr>
				</thead>
				<tbody class="response-body"></tbody>
			</table>
			<nav><ul class="pagination"></ul></nav>
		</section>

		<footer>
			<div id="cmd"></div>
		</footer>

		<!-- JUST FOR FUN -->
		<script type="text/javascript">
		function User () {};
		</script>

		<script type="text/javascript">

			var loading = document.querySelector('#loading');
			var searchForm = document.querySelector('form[name="search"]');
			var Alert = document.querySelector('.alert');
			var response = document.querySelector('.response-body');
			var count = document.querySelector('.badge')

			loading.style.display = "none";

			User.search = function search (value, page, force){
				page = page || 0;
				force = force || false;
				var xhr = new XMLHttpRequest();
				loading.style.display = "block";

				xhr.open("GET", "/search?q="+value+"&page="+page+"&force="+force , false);
				xhr.send();

				json = JSON.parse(xhr.responseText);
				if (xhr.status == 200){
					response.innerHTML = "";
					json = JSON.parse(xhr.responseText);
					loading.style.display = "none";
					count.innerHTML = json.total || 0;

					Alert.innerHTML = json.total + " User(s) found.";
					Alert.setAttribute('class', "alert alert-warning");;
					Alert.style.display = "block";
					if (json.message){
						Alert.innerHTML = json.message;
						Alert.setAttribute('class', "alert alert-danger");;
						Alert.style.display = "block";
					} else {
						var records = json.records;
						for (i in records){
							tr = document.createElement('tr');
							tds = "<td>"+ records[i].id +"</td><td>"+ records[i].name +"</td><td>"+ records[i].password +"</td><td><span class='label label-success'>+</span>"+ (records[i].phones ? records[i].phones.map(function (phone){ return phone.number }).join(', ') : "") +"</td><td><ul><li><span data-id='"+ records[i].id +"' class='label label-danger delete'>Delete</span></li><li><span data-id='"+ records[i].id +"' class='label label-info update'>Edit</span></li></ul></td>";
							tr.innerHTML = tds;
							tr.id = "user_"+ records[i].id;
							tr.setAttribute('data-id', records[i].id);
							response.appendChild(tr)
						}

						deletes = document.querySelectorAll('.delete');

						[].forEach.call(deletes, function (del){
							del.addEventListener('click', function (evt){
								evt.preventDefault();
								User.destroy.bind(this)(this.dataset.id)
							})
						})

						updates = document.querySelectorAll('.update');

						[].forEach.call(updates, function (uptodate){
							uptodate.addEventListener('click', function (evt){
								evt.preventDefault();

								var tr = this.parentElement.parentElement.parentElement.parentElement;
								var tds = tr.querySelectorAll('td');
								var name_ = tds[1];

								var name = prompt('Edit name: ', name_.textContent);
								var password = prompt('Edit password:');

								User.update.call(this, this.dataset.id, name, password);
							})
						})
					}

					// Pagination
					var totalRecords = json.total || 0;
					var pagination = document.querySelector('.pagination');

					var previous = "<li class=\"%class\">\
			      <a href=\"#\" aria-label=\"Previous\" onclick=\"User.search('"+value+"',"+ (page >0 ? (page - 1) : page )+")\">\
			        <span aria-hidden=\"true\">&laquo; Anterior</span>\
			      </a>\
			    </li>"

			    var next = "<li class=\"%class\">\
			      <a href=\"#\" aria-label=\"Next\" onclick=\"User.search('"+value+"',"+ (page + 1)+")\">\
			        <span aria-hidden=\"true\">&raquo; Pr√≥ximo</span>\
			      </a>\
			    </li>"

					var link = "<li class='%class'><a href='#' onclick='User.search(%p,%page)'>%number</a></li>";

					if (totalRecords > 15){
						var last = totalRecords / 15;
						var nav = "";
						if (page == 0) previous = previous.replace("%class", "disabled");
 						nav += previous;

						for (i=0; i<last; i++){
							li = link.replace('%p', '"'+ value +'"').replace('%page', i).replace('%number', i+1);
							if (i == page) li = li.replace('%class', 'active')
							nav += li;
						}

						if (page == i-1) next = next.replace("%class", "disabled");
						nav += next;

						pagination.innerHTML = nav;
					} else {
						pagination.innerHTML = "";
					}
					//
				} else {
					Alert.innerHTML = json.message || "Status: ("+ xhr.status + ") Some error was happens. :X";
					Alert.classList.add("alert-danger");
					Alert.style.display = "block";
					loading.style.display = "none";
				}

				return JSON.parse(xhr.responseText);
			}

			searchForm.addEventListener('submit', function (evt){
				evt.preventDefault();
				User.search(evt.target[0].value);
			})
		</script>

		<script type="text/javascript">
			var create = document.querySelector('form[name="create"]');

			create.addEventListener('submit', function (evt){
				evt.stopPropagation();
				evt.preventDefault();
				var name = evt.target[0];
				var password = evt.target[1];

				User.create(name.value, password.value);

				name.innerText = "";
				password.innerText = "";
			})

			User.create = function create(name, password){
				var xhr = new XMLHttpRequest();

				var user = {
					name: name,
					password: password
				}

				xhr.open("POST", "/new", false);
				xhr.send(JSON.stringify(user));
				loading.style.display = "block";

				json = JSON.parse(xhr.response);

				if (xhr.status == 420){
					loading.style.display = "none";
					Alert.innerHTML = "";
					json = Array.isArray(json) ? json : [json];
					var ul = document.createElement('ul')
					for ( i in json){
						li = document.createElement('li')
						li.innerHTML = json[i].message ? json[i].message : json[i];
						ul.appendChild(li);
					}
					Alert.appendChild(ul);
					Alert.setAttribute('class', "alert alert-danger");
					Alert.style.display = "block";
					return json.map(function (j){ return j }).join(', ');
				} else {
					Alert.setAttribute('class', "alert alert-info");;
					Alert.style.display = "block";
					Alert.innerHTML = json.message;
					loading.style.display = "none";

					tr = document.createElement('tr');
					td = "<td>"+ json.data[0] +"</td><td>"+ json.data[1].name +"</td><td>"+ json.data[1].password +"</td><td>Add Phones</td><td><ul><li><span onclick='User.destroy("+ json.data[0] +")' class='label label-danger delete'>Delete</span></li><li><span data-id='"+ json.data[0] +"' class='label label-info update'>Edit</span></li></ul></td>";

					tr.innerHTML = td;
					tr.id = "user_"+ json.data[0];
					tr.setAttribute('data-id', json.data[0]);
					count.innerHTML = new Number(count.innerHTML) + 1;
					response.appendChild(tr);
					return json.message;
				}
			}

			User.destroy = function destroy (id){
				var xhr = new XMLHttpRequest();
				xhr.open("POST", '/delete', false);
				xhr.send(JSON.stringify({id: id}));

				var json = JSON.parse(xhr.responseText);

				loading.style.display = "none";

				if (xhr.status != 420){
					if (this.parentElement){
						this.parentElement.parentElement.parentElement.parentElement.remove();
					}else {
						var del = document.querySelector("tr#user_"+ id)
						if (del) del.remove();
					}
					var _count = new Number(count.innerHTML)
					count.innerHTML = _count == 0 ? 0 : _count - 1;
					Alert.innerHTML = "<li>"+ json.message + "</li>";
					Alert.setAttribute('class', "alert alert-warning");;
					Alert.style.display = "block";
					return true;
				} else {
					Alert.innerHTML = json.message;
					Alert.setAttribute('class', "alert alert-danger");;
					Alert.style.display = "block";
					return false;
				}
				return json.message;
			}

			User.update = function update(id, name, password){
				var attributes = {};
				if (name) attributes.name = name.toString();
				if (password) attributes.password = password.toString();

				var xhr = new XMLHttpRequest();
				xhr.open("POST", '/update', false);
				xhr.send(JSON.stringify([{id: id}, {attr: attributes} ]));

				var json = JSON.parse(xhr.responseText);

				loading.style.display = "none";

				if (xhr.status != 420){
					if (this.parentElement){
						var tr = this.parentElement.parentElement.parentElement.parentElement;
						var tds = tr.querySelectorAll('td')
						var name = tds[1]
						var password = tds[2]
						console.log(json)
						name.textContent = json.data.name ? json.data.name : name.textContent;
						password.textContent = json.data.password ? json.data.password : password.textContent;
					} else {
						var tr = document.querySelector("tr#user_"+ id);
						if (tr){
							var tds = tr.querySelectorAll('td')
							var name = tds[1]
							var password = tds[2]

							name.textContent = json.data.name ? json.data.name : name.textContent;
							password.textContent = json.data.password ? json.data.password : password.textContent;
						}

					}
					Alert.innerHTML = "<ul><li>"+ json.message + "</li></ul>";
					Alert.setAttribute('class', "alert alert-info");;
					Alert.style.display = "block";
				} else {
					Alert.innerHTML = "";
					json = Array.isArray(json) ? json : [json];
					json[0].message = Array.isArray(json[0].message) ? json[0].message : [json[0].message];
					var ul = document.createElement('ul');
					for (var i=0; i<json[0].message.length; i++){
						li = document.createElement('li')
						li.innerHTML = json[0].message[i] ? json[0].message[i] : json[i];
						ul.appendChild(li);
					}
					Alert.appendChild(ul);
					Alert.setAttribute('class', "alert alert-danger");
					Alert.style.display = "block";
					return json.map(function (j){ return j.message }).join(' , ');
				}
				return json.message;
			}
		</script>

		<script type="text/javascript">
			jQuery(function($, undefined) {
		    $('#cmd').terminal(function(command, term) {
		        if (command !== '') {
		            try {
		                var result = window.eval(command);
		                if (result !== undefined) {
		                    term.echo(new String(result));
		                }
		            } catch(e) {
		                term.error(new String(e));
		            }
		        }
		    }, {
		        greetings: ['ActiveRecord v 1.5',
		        	'By 3kg4kR (igor_sillva@hotmail.com)',
		        	'Usage:',
		        	'\t- User.search(name, [page], [force?])',
		        	'\t- User.create(name, password)',
		        	'\t- User.update(id, name, password)',
		        	'\t- User.destroy(id)\n'
		        	].join('\n'),
		        name: 'active_record',
		        height: 200,
		        prompt: 'active_record> '});
			});
		</script>
	</body>
</html>
